<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Компас Киблы</title>
  <!-- Google Fonts: Arabic + Calligraphy -->
  <link href="https://fonts.googleapis.com/css?family=Scheherazade&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Marhey:wght@700&family=Lateef:wght@700&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      background: #e8f7ee;
      font-family: 'Scheherazade', 'Lateef', serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .header {
      background: #166c43;
      color: #fff;
      width: 100%;
      text-align: center;
      padding: 22px 0 16px 0;
      position: relative;
      box-shadow: 0 8px 40px -12px #157a5a45;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 78px;
    }
    .header h1 {
      font-family: 'Marhey', cursive;
      font-size: 2em;
      margin-bottom: 0.2em;
      margin-top: 0.2em;
      line-height: 1.2;
      color: #fffad4;
      text-shadow: 0 2px 8px #12806370;
    }
    .back-btn {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      background: #128063;
      color: #fff;
      border: none;
      border-radius: 7px;
      font-size: 1em;
      font-weight: bold;
      padding: 7px 18px;
      cursor: pointer;
      box-shadow: 0 2px 8px #173e1f40;
      transition: background 0.15s;
      font-family: inherit;
      z-index: 2;
    }
    .back-btn:hover, .back-btn:focus {
      background: #0c6240;
    }
    .arabic {
      font-family: 'Lateef', 'Scheherazade', serif;
      font-size: 1.7em;
      color: #fae69e;
      margin-bottom: 0;
      letter-spacing: 0.13em;
      line-height: 1.5;
    }
    .islamic-border {
      width: 340px;
      margin: 24px auto 0;
      background: #fff;
      border-radius: 50%;
      border: 8px solid #f1e6b1;
      box-shadow: 0 4px 24px #157a5a20;
      position: relative;
      overflow: hidden;
      min-width:260px;
      min-height: 340px;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    .islamic-ornament {
      position: absolute;
      width: 100%;
      top: -18px; left: 0;
      opacity: 0.11;
      z-index: 1;
      pointer-events: none;
      user-select: none;
    }
    #compass {
      margin: 0 auto;
      width: 210px;
      height: 210px;
      border-radius: 50%;
      box-shadow: 0 2px 32px #12806320;
      background: linear-gradient(150deg, #ebf6e1 60%, #e0edd4 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border: 6px solid #128063;
      z-index: 2;
    }
    .center-dot {
      position: absolute;
      left: 50%; top: 50%;
      width: 18px; height: 18px;
      margin-left: -9px; margin-top: -9px;
      background: #ebb500;
      border-radius: 50%;
      border: 3px solid #138c68;
      z-index: 5;
      box-shadow: 0 2px 6px #138c6830;
    }
    #needle {
      width: 9px;
      height: 92px;
      background: linear-gradient(180deg, #ebb500 0%, #2d684e 100%);
      position: absolute;
      left: 50%; top: 34px;
      margin-left: -4.5px;
      border-radius: 6px 6px 36px 36px;
      box-shadow: 0 2px 6px #157a5a40;
      z-index: 4;
      transform-origin: bottom center;
      transition: transform 0.8s cubic-bezier(.35,.89,.49,1.03);
    }
    .compass-label-n {
      position: absolute;
      top: 10px; left: 50%;
      transform: translate(-50%,0);
      color: #128063; font-weight: bold;
      font-family: 'Marhey', sans-serif;
      font-size: 1.2em; letter-spacing: 0.12em;
      z-index:9; background: #fff8; border-radius: 12px; padding: 1px 8px;
    }
    .compass-label-kaaba {
      position: absolute;
      bottom: 10px; left: 50%;
      transform: translate(-50%,0);
      color: #ebb500; font-family: 'Lateef', serif; font-size: 1.1em;
      z-index:9; background: #fffb; border-radius: 12px; padding: 0 10px;
    }
    #info {
      margin-top: 24px;
      font-size: 1em;
      color: #157a5a;
      z-index: 3;
      max-width: 340px;
      line-height: 1.7;
    }
    .dua {
      font-family: 'Lateef', serif;
      font-size: 1.05em;
      color: #128063;
      margin-top: 18px;
      background: #fff7;
      border-radius: 7px;
      box-shadow: 0 1px 5px #12806315;
      padding: 10px 20px;
      max-width: 320px;
      margin-left: auto;
      margin-right: auto;
    }
    @media (max-width: 480px) {
      .islamic-border, #compass { width:96vw; min-width: 190px; }
      #compass { height: 44vw; min-height:140px; }
      .islamic-border { height:auto; padding:8px;}
      .header h1 { font-size: 1.3em;}
      .arabic { font-size:1.1em;}
      .header { min-height: 62px; padding: 14px 0 10px 0; }
      .back-btn { left:6px; padding:5px 13px; font-size:0.97em; }
    }
  </style>
</head>
<body>
  <div class="header">
    <button class="back-btn" onclick="if(document.referrer && document.referrer!==window.location.href){window.history.back();}else{window.location.href='index.html';}">← Назад</button>
    <div style="flex:1;">
      <h1>Компас Киблы</h1>
      <div class="arabic">بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيم <br>الإتجاه نحو الكعبة</div>
    </div>
  </div>
  <div class="islamic-border">
      <!-- Украшение - SVG-узор -->
      <svg class="islamic-ornament" height="52" viewBox="0 0 360 52" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M11 43C57 8 303 8 349 43" stroke="#f9cca2" stroke-width="5" fill="none" opacity="0.55"/>
      <circle cx="29" cy="32" r="6" stroke="#ebb500" stroke-width="4" fill="#fff"/>
      <circle cx="331" cy="32" r="6" stroke="#ebb500" stroke-width="4" fill="#fff"/>
      <path d="M180 31c8-7 8-23 0-30-8 7-8 23 0 30z" fill="#f9e9b2" stroke="#ebb500" stroke-width="2"/>
      <circle cx="180" cy="16" r="5" fill="#ebb500"/>
      </svg>
      <div id="compass">
        <div class="compass-label-n">С</div>
        <div id="needle"></div>
        <div class="center-dot"></div>
        <div class="compass-label-kaaba">قِبْلَة‎</div>
      </div>
      <div id="info">Загрузка вашего местоположения…</div>
  </div>
  <div class="dua">
    اللَّهُمَّ وَجِّهْ قُلُوبَنَا إِلَى قِبْلَتِكَ<br>
    <span style="font-size:0.9em; color:#867c53;"><br>О Аллах, обрати наши сердца к Твоей Кибле!</span>
  </div>
<script>
  // Координаты Каабы
  const kaaba = {lat: 21.4224779, lng: 39.8251832};
  function toRad(deg) { return deg * Math.PI / 180;}
  function toDeg(rad) { return rad * 180 / Math.PI;}
  function getQiblaAngle(lat, lng) {
    const φK = toRad(kaaba.lat);
    const λK = toRad(kaaba.lng);
    const φ = toRad(lat);
    const λ = toRad(lng);
    let y = Math.sin(λK-λ);
    let x = Math.cos(φ)*Math.tan(φK) - Math.sin(φ)*Math.cos(λK-λ);
    let θ = Math.atan2(y, x);
    // Азимут относительно Севера, по часовой стрелке
    return (toDeg(θ)+360)%360;
  }
  // Отобразить стрелку компаса
  function showCompass(angle) {
    document.getElementById('needle').style.transform = `rotate(${angle}deg)`;
  }
  // Основная логика:
  let userLat = null, userLng = null, qibla = null;
  // Актуализирует стрелку при повороте устройства (на телефонах)
  function onDeviceOrientation(event) {
    let alpha = event.alpha;
    if (typeof event.webkitCompassHeading !== "undefined") {
      // iOS Safari
      alpha = event.webkitCompassHeading;
    } else if (event.absolute === false || alpha === null) {
      // Не поддерживается
      return;
    }
    if (userLat !== null && userLng !== null) {
      // Разница между направлением устройства (alpha) и азимутом на Киблу
      let deviation = (qibla - alpha + 360) % 360;
      showCompass(deviation);
    }
  }
  // Получаем геолокацию
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(pos){
      userLat = pos.coords.latitude;
      userLng = pos.coords.longitude;
      qibla = getQiblaAngle(userLat, userLng);
      showCompass(qibla);  // Стрелка на киблу
      document.getElementById('info').innerHTML =
        "Ваш азимут на Киблу: <b>"+qibla.toFixed(2)+"&deg;</b> &nbsp; <br><span style='font-size:0.97em;'>Разместите устройство горизонтально,<br> стрелка указывает направление на Каабу.</span>";
      // Пытаемся включить DeviceOrientation на мобильных
      if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
        // iOS 13+
        var activateBtn = document.createElement('button');
        activateBtn.textContent = 'Активация компаса устройства';
        activateBtn.style = 'margin-top:13px;background:#ebb500;color:#fff; border:none; border-radius:8px; font-size:1em;padding:9px 18px; cursor:pointer; box-shadow:0 2px 6px #157a5a28;';
        activateBtn.onclick = function(){
          DeviceOrientationEvent.requestPermission().then(function(response){
            if(response === 'granted'){
              window.addEventListener('deviceorientation', onDeviceOrientation, true);
              activateBtn.remove();
            }
          });
        };
        document.getElementById('info').appendChild(document.createElement('br'));
        document.getElementById('info').appendChild(activateBtn);
      } else if (window.DeviceOrientationEvent) {
        window.addEventListener('deviceorientation', onDeviceOrientation, true);
      }
    }, function(err){
      document.getElementById('info').innerHTML = "⛔️ Не удалось получить ваше местоположение.<br>Разрешите доступ к геолокации в настройках браузера.";
    });
  } else {
    document.getElementById('info').textContent = "⛔️ Геолокация не поддерживается вашим браузером";
  }
</script>
</body>
</html>