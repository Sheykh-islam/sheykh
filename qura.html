<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Компас Киблы</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link href="https://fonts.googleapis.com/css?family=Scheherazade&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Marhey:wght@700&family=Lateef:wght@700&display=swap" rel="stylesheet">
  <style>
    html, body {
      background: #e8f7ee;
      font-family: 'Scheherazade', 'Lateef', serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .header {
      background: #166c43;
      color: #fff;
      width: 100%;
      text-align: center;
      padding: 18px 0 10px 0;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 64px;
      box-sizing: border-box;
    }
    .header h1 {
      font-family: 'Marhey', cursive;
      font-size: 1.6em;
      margin: 0.05em 0 0.12em 0;
      color: #fffad4;
      text-shadow: 0 2px 8px #12806370;
    }
    .back-btn {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: #128063;
      color: #fff;
      border: none;
      border-radius: 7px;
      font-size: 1em;
      font-weight: bold;
      padding: 7px 18px;
      cursor: pointer;
      box-shadow: 0 1px 6px #173e1f28;
      transition: background 0.15s;
      font-family: inherit;
      z-index: 2;
      touch-action: manipulation;
    }
    .back-btn:active, .back-btn:hover, .back-btn:focus {
      background: #0c6240;
    }
    .arabic {
      font-family: 'Lateef', 'Scheherazade', serif;
      font-size: 1.3em;
      color: #fae69e;
      margin-bottom: 0;
      margin-top: 0.15em;
      letter-spacing: 0.13em;
      line-height: 1.5;
    }
    .islamic-border {
      width: 96vw;
      max-width: 350px;
      margin: 18px auto 0;
      background: #fff;
      border-radius: 32px;
      border: 5px solid #f1e6b1;
      box-shadow: 0 2px 24px #157a5a15;
      position: relative;
      overflow: hidden;
      min-width: 0;
      min-height: 265px;
      padding: 7vw 0 5vw 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      box-sizing: border-box;
    }
    .islamic-ornament {
      position: absolute;
      width: 88%;
      left: 6%;
      top: -12px;
      opacity: 0.13;
      z-index: 1;
      pointer-events: none;
      user-select: none;
    }
    #compass {
      margin: 0;
      width: 66vw;
      max-width: 210px;
      min-width: 120px;
      height: 66vw;
      max-height: 210px;
      min-height: 120px;
      border-radius: 50%;
      box-shadow: 0 2px 16px #12806315;
      background: linear-gradient(150deg, #ebf6e1 60%, #e0edd4 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border: 4px solid #128063;
      z-index: 2;
      touch-action: none;
    }
    .center-dot {
      position: absolute;
      left: 50%; top: 50%;
      width: 13%;
      max-width: 18px;
      min-width: 9px;
      aspect-ratio: 1/1;
      margin-left: -6.5%;
      margin-top: -6.5%;
      background: #ebb500;
      border-radius: 50%;
      border: 3px solid #138c68;
      z-index: 5;
      box-shadow: 0 2px 6px #138c6830;
    }
    #needle {
      width: 4.5%;
      min-width: 6px; max-width: 11px;
      height: 45%;
      min-height: 40px; max-height: 92px;
      background: linear-gradient(180deg, #ebb500 0%, #2d684e 100%);
      position: absolute;
      left: 50%; top: 11%;
      margin-left: -2.25%;
      border-radius: 6px 6px 36px 36px;
      box-shadow: 0 2px 6px #157a5a40;
      z-index: 4;
      transform-origin: bottom center;
      transition: transform 0.8s cubic-bezier(.35,.89,.49,1.03);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
    }
    .kaaba-icon {
      z-index: 6;
      width: 27px;
      height: 27px;
      position: absolute;
      left: 50%;
      top: 16px;
      margin-left: -13.5px;
      text-align: center;
      pointer-events: none;
    }
    .compass-label-n {
      position: absolute;
      top: 6px; left: 50%;
      transform: translate(-50%,0);
      color: #128063; font-weight: bold;
      font-family: 'Marhey', sans-serif;
      font-size: 1.02em; letter-spacing: 0.09em;
      z-index:9; background: #fff8; border-radius: 9px; padding: 1.5px 7px;
      pointer-events: none;
    }
    .compass-label-kaaba {
      position: absolute;
      bottom: 8px; left: 50%;
      transform: translate(-50%,0);
      color: #ebb500; font-family: 'Lateef', serif; font-size: 0.97em;
      z-index:9; background: #fffb; border-radius: 11px; padding: 0 9px;
      pointer-events: none;
    }
    #info {
      margin-top: 16px;
      font-size: 0.97em;
      color: #157a5a;
      z-index: 3;
      max-width: 98vw;
      word-wrap: break-word;
      line-height: 1.6;
      text-align: center;
      min-height: 42px;
    }
    .dua {
      font-family: 'Lateef', serif;
      font-size: 1em;
      color: #128063;
      margin-top: 16px;
      background: #fffffa;
      border-radius: 7px;
      box-shadow: 0 1px 5px #12806315;
      padding: 8px 3vw;
      max-width: 95vw;
      margin-left: auto;
      margin-right: auto;
      text-align: center;
    }
    .manual-address-wrap {
      margin: 11px auto 3px auto;
      text-align: center;
      width: 93vw;
      max-width: 320px;
      display:block;
      position: relative;
    }
    .manual-address-wrap input {
      font-size: 1em;
      border: 1px solid #c1daca;
      border-radius: 6px;
      padding: 7px 9px;
      width:65%;
      max-width: 170px;
      min-width:74px;
      box-sizing: border-box;
    }
    .manual-address-wrap button {
      background: #ebb500;
      color: #fff;
      border: none;
      border-radius: 7px;
      font-size: 1em;
      font-weight: bold;
      padding: 7px 13px;
      margin-left: 5px;
      cursor: pointer;
      transition: background 0.14s;
      box-shadow: 0 1px 4px #ebb5001a;
    }
    .manual-address-wrap button:active, .manual-address-wrap button:hover, .manual-address-wrap button:focus {
      background: #c08a3d;
    }
    #addressStatus {
      font-size: 0.96em;
      color: #b81515;
      min-height:21px;
      margin-top: 4px;
      text-align: center;
    }
    .suggestions {
      position: absolute;
      left: 0;
      right: 0;
      top: 40px;
      max-height: 185px;
      overflow-y: auto;
      overflow-x: hidden;
      background: #fff;
      border: 1px solid #d6d6ba;
      z-index: 20;
      border-radius: 0 0 8px 8px;
      font-size: 0.96em;
      text-align: left;
      box-shadow: 0 2px 8px #12806327;
    }
    .suggestion {
      padding: 8px 11px;
      cursor: pointer;
      color: #166c43;
      border-bottom: 1px solid #f0eee1;
      transition: background 0.16s;
      background: #fff;
      white-space: normal;
      word-break: break-word;
    }
    .suggestion:last-child {
      border-bottom: none;
    }
    .suggestion:hover, .suggestion.active {
      background: #effff1;
    }
    .slider-rotate-wrap {
      margin: 10px auto 6px auto;
      text-align: center;
      color: #388355;
      font-size:0.97em;
    }
    input[type="range"] {
      width: 60vw; max-width: 200px;
    }
    @media (max-width: 440px) {
      .header h1 { font-size: 1.13em;}
      .arabic { font-size:0.95em;}
      .islamic-border { border-width: 3px; }
      .dua { font-size: 0.97em; padding:8px 2vw;}
      .back-btn { left:3px; padding:5px 10px; font-size:0.97em; }
      #info { font-size: 0.97em;}
      .kaaba-icon { width:20px;height:20px;margin-left:-10px;top:18px;}
      input[type="range"] {width: 80vw;}
    }
    @media (max-width: 360px) {
      .islamic-border { padding: 3vw 0; }
      .dua { padding: 5px 1vw;}
    }
  </style>
</head>
<body>
  <div class="header">
    <button
      class="back-btn"
      onclick="if(document.referrer && document.referrer!==window.location.href){window.history.back();}else{window.location.href='index.html';}">
      ← Назад
    </button>
    <div style="flex:1;">
      <h1>Компас Киблы</h1>
      <div class="arabic">
        بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيم <br>الإتجاه نحو الكعبة
      </div>
    </div>
  </div>
  <div class="islamic-border">
    <svg class="islamic-ornament" height="42" viewBox="0 0 360 52" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M11 43C57 8 303 8 349 43" stroke="#f9cca2" stroke-width="5" fill="none" opacity="0.55"/>
      <circle cx="29" cy="32" r="6" stroke="#ebb500" stroke-width="4" fill="#fff"/>
      <circle cx="331" cy="32" r="6" stroke="#ebb500" stroke-width="4" fill="#fff"/>
      <path d="M180 31c8-7 8-23 0-30-8 7-8 23 0 30z" fill="#f9e9b2" stroke="#ebb500" stroke-width="2"/>
      <circle cx="180" cy="16" r="5" fill="#ebb500"/>
    </svg>
    <div id="compass">
      <div class="compass-label-n">С</div>
      <div id="needle">
        <svg class="kaaba-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 65 65">
          <rect x="8" y="25" width="49" height="32" rx="5" fill="#111"/>
          <rect x="8" y="17" width="49" height="14" rx="4" fill="#bba145"/>
          <rect x="15" y="42" width="35" height="7" fill="#bba145"/>
          <rect x="13" y="29" width="9" height="6" rx="2" fill="#fff2b8" opacity="0.95"/>
        </svg>
      </div>
      <div class="center-dot"></div>
      <div class="compass-label-kaaba">قِبْلَة‎</div>
    </div>
    <div id="info">Загрузка вашего местоположения…</div>
    <div class="manual-address-wrap" id="manualAddr">
      <form onsubmit="return false;" autocomplete="off" style="position:relative">
        <input id="addressInput" type="text" placeholder="Город, адрес или страна" required autocomplete="off">
        <div id="suggestions" class="suggestions" style="display:none;"></div>
        <button id="addrBtn" type="button">Установить</button>
      </form>
      <div id="addressStatus"></div>
      <div style="color:#827747; font-size:0.92em; margin-top:4px;">
        Введите, например: <i>Москва</i>, <i>Ташкент</i>, <i>Paris, France</i> и т.д.
      </div>
    </div>
    <div class="slider-rotate-wrap" id="sliderWrap" style="display:none;">
      Вращайте компас: <input type="range" min="0" max="359" value="0" id="angleSlider">
    </div>
  </div>
  <div class="dua">
    اللَّهُمَّ وَجِّهْ قُلُوبَنَا إِلَى قِبْلَتِكَ<br>
    <span style="font-size:0.95em; color:#867c53;"><br>О Аллах, обрати наши сердца к Твоей Кибле!</span>
  </div>
<script>
  const kaaba = {lat: 21.4224779, lng: 39.8251832};
  let userLat = null, userLng = null, qibla = null, geoAvailable = false;
  const angleSlider = document.getElementById('angleSlider');
  const addressInput = document.getElementById('addressInput');
  const addressStatus = document.getElementById('addressStatus');
  const suggestionsBox = document.getElementById('suggestions');
  let suggestionList = [];

  function toRad(deg) { return deg * Math.PI / 180;}
  function toDeg(rad) { return rad * 180 / Math.PI;}
  function getQiblaAngle(lat, lng) {
    const φK = toRad(kaaba.lat);
    const λK = toRad(kaaba.lng);
    const φ = toRad(lat);
    const λ = toRad(lng);
    let y = Math.sin(λK-λ);
    let x = Math.cos(φ)*Math.tan(φK) - Math.sin(φ)*Math.cos(λK-λ);
    let θ = Math.atan2(y, x);
    return (toDeg(θ)+360)%360;
  }
  function showCompass(angle) {
    document.getElementById('needle').style.transform = `rotate(${angle}deg)`;
  }

  angleSlider.addEventListener('input', function(){
    let angle = parseInt(this.value,10);
    if (userLat !== null && userLng !== null && qibla !== null) {
      let deviation = (qibla - angle + 360) % 360;
      showCompass(deviation);
    }
  });

  function onDeviceOrientation(event) {
    let alpha = event.alpha;
    if (typeof event.webkitCompassHeading !== "undefined") {
      alpha = event.webkitCompassHeading;
    } else if (event.absolute === false || alpha === null) {
      return;
    }
    if (userLat !== null && userLng !== null) {
      let deviation = (qibla - alpha + 360) % 360;
      showCompass(deviation);
    }
  }

  document.getElementById('addrBtn').onclick = geocodeAddress;
  addressInput.oninput = function() {
    showSuggestions(this.value);
  };
  addressInput.onblur = function() { setTimeout(()=>suggestionsBox.style.display='none', 120);}
  addressInput.onfocus = function() { if(suggestionList.length) suggestionsBox.style.display='block'; }

  function geocodeAddress(useSuggestion) {
    let addr;
    if (typeof useSuggestion === 'object' && useSuggestion.lat !== undefined) {
      addr = useSuggestion;
    } else {
      let v = addressInput.value.trim();
      if (!v) return false;
      addressStatus.textContent = "Поиск...";
      fetch("https://nominatim.openstreetmap.org/search?format=json&q=" + encodeURIComponent(v))
        .then(r=>r.json()).then(function(res){
          if (!res || !res.length) {
            addressStatus.textContent = "Ничего не найдено. Попробуйте другой адрес/город.";
            return;
          }
          addresstoQibla(res[0]);
        }).catch(function(){
          addressStatus.textContent = "Ошибка сети. Попробуйте позже.";
        });
      return;
    }
    // Если пришли с click autocomplete
    addresstoQibla(addr);
  }

  function addresstoQibla(loc) {
    userLat = parseFloat(loc.lat);
    userLng = parseFloat(loc.lon);
    qibla = getQiblaAngle(userLat, userLng);
    addressStatus.textContent = "Город/адрес: "+ (loc.display_name.split(",")[0]);
    document.getElementById('info').innerHTML =
      "Ваш азимут на Киблу: <b>"+qibla.toFixed(2)+"&deg;</b> <br><span style='font-size:0.97em;'>Вы можете вращать компас вручную.<br>Стрелка указывает направление на Каабу.</span>";
    document.getElementById('sliderWrap').style.display = "";
    showCompass(qibla);
    suggestionsBox.style.display = 'none';
  }

  let lastInputTime = 0;
  function showSuggestions(v) {
    suggestionList = [];
    if (!v.trim()) {
      suggestionsBox.style.display = 'none';
      return;
    }
    let now = Date.now();
    lastInputTime = now;
    setTimeout(() => {
      if (now !== lastInputTime) return;
      fetch("https://nominatim.openstreetmap.org/search?format=json&limit=6&q=" + encodeURIComponent(v))
        .then(r=>r.json()).then(function(res){
          suggestionsBox.innerHTML = "";
          if (!res || !res.length) { suggestionsBox.style.display='none'; return;}
          suggestionList = res;
          for (let i = 0; i < res.length; i++) {
            let s = document.createElement('div');
            s.className = "suggestion";
            s.innerText = res[i].display_name;
            s.onclick = function(){
              addressInput.value = res[i].display_name;
              geocodeAddress(res[i]);
            };
            suggestionsBox.appendChild(s);
          }
          suggestionsBox.style.display = 'block';
        });
    }, 270);
  }

  function geoFail() {
    document.getElementById('info').innerHTML = "Не удалось определить ваше местоположение.<br>Пожалуйста, введите свой город или адрес вручную!";
    document.getElementById('sliderWrap').style.display = "";
  }
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(pos){
      userLat = pos.coords.latitude;
      userLng = pos.coords.longitude;
      qibla = getQiblaAngle(userLat, userLng);
      geoAvailable = true;
      showCompass(qibla);
      document.getElementById('info').innerHTML =
        "Ваш азимут на Киблу: <b>"+qibla.toFixed(2)+"&deg;</b> &nbsp;<br><span style='font-size:0.97em;'>Разместите устройство горизонтально,<br> стрелка указывает направление на Каабу.</span>";
      if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
        var activateBtn = document.createElement('button');
        activateBtn.textContent = 'Активация компаса устройства';
        activateBtn.style = 'margin-top:13px;background:#ebb500;color:#fff; border:none; border-radius:8px; font-size:1em;padding:9px 18px; cursor:pointer; box-shadow:0 2px 6px #157a5a28;';
        activateBtn.onclick = function(){
          DeviceOrientationEvent.requestPermission().then(function(response){
            if(response === 'granted'){
              window.addEventListener('deviceorientation', onDeviceOrientation, true);
              activateBtn.remove();
            }
          });
        };
        document.getElementById('info').appendChild(document.createElement('br'));
        document.getElementById('info').appendChild(activateBtn);
      } else if (window.DeviceOrientationEvent) {
        window.addEventListener('deviceorientation', onDeviceOrientation, true);
      } else {
        document.getElementById('sliderWrap').style.display = "";
      }
    }, geoFail, {timeout:8000});
  } else {
    geoFail();
  }
</script>
</body>
</html>
